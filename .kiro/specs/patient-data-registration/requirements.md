# Patient Data Registration - 要件定義書

## はじめに

このspecは、NextMed MVPの要件1「患者データ登録」を実装するためのものです。
Midnight Blockchainのゼロ知識証明技術を活用し、患者の医療データをプライバシーを保護しながら登録する機能を提供します。

## 用語集

- **Patient (患者)**: 医療データを登録するデータ主体
- **Patient Data (患者データ)**: 年齢、性別、症例情報を含む医療データ
- **Patient ID (患者ID)**: 患者を一意に識別するが、実際の身元とはリンクしない識別子
- **Commitment (コミットメント)**: データのハッシュ化された表現で、元データを明かさずに存在を証明
- **Witness Function**: オフチェーンで実行され、プライベートデータを提供する関数
- **Merkle Tree**: データの整合性を効率的に検証できるデータ構造
- **ZK Proof (ゼロ知識証明)**: データの内容を明かさずに、その正当性を証明する暗号技術

## 要件

### 要件1: 患者データの安全な登録

**ユーザーストーリー:**

患者として、自分の医療データ（年齢、性別、症例）をプラットフォームに登録したい。
そうすることで、医療研究に貢献しながら、自分のプライバシーを完全に保護できる。

#### 受入基準

1. WHEN 患者が年齢、性別、症例データを送信したとき、THE スマートコントラクトは、データをコミットメント形式でMerkle Treeに保存しなければならない

2. WHEN データが保存されたとき、THE スマートコントラクトは、患者の秘密鍵とランダムネスから一意の患者識別子を生成しなければならない

3. THE スマートコントラクトは、生の医療データが公開台帳に決して露出しないことを保証しなければならない

4. WHEN 患者がデータを登録したとき、THE スマートコントラクトは、患者IDを返却しなければならない

5. IF 年齢が0歳未満または150歳を超える場合、THEN THE スマートコントラクトは、登録を拒否しなければならない

### 要件2: 患者識別子の管理

**ユーザーストーリー:**

システム管理者として、登録された患者の識別子を管理したい。
そうすることで、患者の身元を明かすことなく、登録状況を追跡できる。

#### 受入基準

1. THE スマートコントラクトは、患者IDと登録時刻を含む識別子情報を公開台帳に保存しなければならない

2. WHEN 患者IDが提供されたとき、THE スマートコントラクトは、その患者が登録済みかどうかを検証できなければならない

3. THE スマートコントラクトは、登録された患者の総数をカウントしなければならない

4. THE スマートコントラクトは、同じ患者が複数回登録できることを許可しなければならない（異なるランダムネスにより異なるIDが生成される）

### 要件3: データプライバシーの保証

**ユーザーストーリー:**

患者として、自分の医療データがゼロ知識証明によって保護されることを確認したい。
そうすることで、データが研究に使用される場合でも、プライバシーが保証される。

#### 受入基準

1. THE スマートコントラクトは、すべてのプライベートデータ入力をWitness関数を通じて処理しなければならない

2. THE スマートコントラクトは、データのコミットメントを生成する際に暗号学的に安全なランダムネスを使用しなければならない

3. THE スマートコントラクトは、患者データのコミットメントをHistoricMerkleTreeに保存しなければならない

4. THE スマートコントラクトは、公開台帳に保存される情報に対してのみdisclose()ラッパーを使用しなければならない

5. THE スマートコントラクトは、ゼロ知識証明を通じてデータ登録の正当性を検証しなければならない

### 要件4: データ検証とクエリ

**ユーザーストーリー:**

研究者として、患者が登録されているかどうかを確認したい。
そうすることで、データの存在を確認しながら、患者のプライバシーを侵害しない。

#### 受入基準

1. WHEN 患者IDが提供されたとき、THE スマートコントラクトは、その患者が登録されているかどうかをBoolean値で返さなければならない

2. THE スマートコントラクトは、登録された患者の総数を取得できる機能を提供しなければならない

3. THE スマートコントラクトは、個別の患者データを露出することなく、存在確認のみを行わなければならない

## 技術的制約

1. **Compact言語バージョン**: 0.16以上
2. **Merkle Tree深度**: 20レベル（最大1,048,576患者）
3. **年齢範囲**: 0-150歳（Uint<8>で表現）
4. **症例データ**: Bytes<32>のハッシュ形式
5. **患者ID**: Bytes<32>の一意識別子

## セキュリティ要件

1. 秘密鍵は決して公開台帳に保存されない
2. ランダムネスは暗号学的に安全な方法で生成される
3. コミットメントは衝突耐性のあるハッシュ関数を使用
4. Witness関数の結果は信頼できない入力として扱われる
5. すべてのアサーションは実行時に検証される

## 非機能要件

1. **パフォーマンス**: 患者登録は10秒以内に完了
2. **スケーラビリティ**: 最大100万人の患者データを管理可能
3. **可用性**: スマートコントラクトは24/7稼働
4. **監査可能性**: すべての登録はブロックチェーン上で追跡可能
5. **相互運用性**: TypeScriptから容易に呼び出し可能
